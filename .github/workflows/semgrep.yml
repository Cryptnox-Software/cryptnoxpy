name: Semgrep Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 00:00 UTC to catch new vulnerabilities
    - cron: '0 0 * * *'

permissions:
  contents: read
  security-events: write  # Required for SARIF upload
  pull-requests: write    # For PR comments

jobs:
  semgrep:
    runs-on: ubuntu-latest
    
    # Skip scheduled runs on forks
    if: (github.event_name != 'schedule') || (github.repository == 'Cryptnox-Software/cryptnox-sdk-py')
    
    container:
      # Official Semgrep Docker image
      image: semgrep/semgrep
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep Security Scan
        id: semgrep
        continue-on-error: true
        run: |
          echo "Running Semgrep security analysis..."
          echo "===================================="
          echo ""
          
          # Run Semgrep with multiple rulesets
          semgrep scan \
            --config=auto \
            --config=p/python \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --config=p/cryptography \
            --sarif \
            --sarif-output=semgrep.sarif \
            --json \
            --json-output=semgrep.json \
            --verbose \
            --metrics=off
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      - name: Upload Semgrep SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
          category: semgrep
      
      - name: Upload Semgrep reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: |
            semgrep.json
            semgrep.sarif
          if-no-files-found: warn
      
      - name: Check Semgrep results
        if: steps.semgrep.outcome == 'failure'
        run: |
          echo "⚠️  Semgrep found security issues"
          echo ""
          echo "Review the findings:"
          echo "  1. Check the output above for details"
          echo "  2. Go to Security -> Code scanning -> Semgrep category"
          echo "  3. Download artifacts for full reports"
          echo ""
          echo "Note: Some findings may be false positives."
          echo "Review each one carefully before taking action."
          exit 1

