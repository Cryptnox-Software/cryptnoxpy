name: Pylint Code Quality

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write  # Required for SARIF upload
  pull-requests: write    # Optional: for PR comments

jobs:
  pylint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.13.7"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint pylint-sarif sarif-tools

      - name: Run Pylint analysis
        id: pylint
        continue-on-error: true
        run: |
          echo "Running Pylint analysis..."
          
          # Run pylint and save output to JSON (always create the file)
          set +e  # Don't exit on error
          pylint cryptnox_sdk_py \
            --output-format=json \
            --fail-under=7.0 \
            --fail-on=error,fatal > pylint-report.json
          PYLINT_EXIT=$?
          set -e  # Re-enable exit on error
          
          echo "Pylint exit code: $PYLINT_EXIT"
          
          # Display results in console (colorized) for visibility
          echo ""
          echo "=== Pylint Results (Console) ==="
          pylint cryptnox_sdk_py \
            --output-format=colorized \
            --fail-under=7.0 \
            --fail-on=error,fatal || true
          
          # Verify JSON file was created
          if [ -f pylint-report.json ] && [ -s pylint-report.json ]; then
            echo ""
            echo "âœ“ JSON report generated successfully"
            ls -lh pylint-report.json
          else
            echo ""
            echo "âœ— Failed to generate JSON report or file is empty"
            exit 1
          fi
          
          # Exit with pylint's exit code (but continue-on-error will handle it)
          exit $PYLINT_EXIT

      - name: Convert Pylint report to SARIF
        if: always()
        run: |
          if [ -f pylint-report.json ]; then
            echo "Converting Pylint JSON to SARIF format..."
            pylint-sarif -o pylint.sarif pylint-report.json
            echo "âœ“ SARIF file created successfully"
            ls -lh pylint.sarif
          else
            echo "âœ— Error: pylint-report.json not found"
            exit 1
          fi

      - name: Upload Pylint SARIF to GitHub Security
        if: always() && hashFiles('pylint.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: pylint.sarif
          category: pylint-${{ matrix.python-version }}

      - name: Upload Pylint reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pylint-reports-py${{ matrix.python-version }}
          path: |
            pylint-report.json
            pylint.sarif
          if-no-files-found: warn

      - name: Check Pylint results
        if: steps.pylint.outcome == 'failure'
        run: |
          echo "âŒ Pylint analysis failed"
          echo "This means either:"
          echo "  - Code quality score is below 7.0, or"
          echo "  - Error or Fatal level issues were found"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  1. Review the Pylint output above"
          echo "  2. Check GitHub Security -> Code scanning for detailed findings"
          echo "  3. Download artifacts for full reports"
          echo "  4. Run locally: ./run-pylint-local.sh (or .ps1 on Windows)"
          exit 1
